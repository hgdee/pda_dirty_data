---
title: "D12 Dirty Data Project"
output:
  html_document: 
    number_sections: yes
    toc: yes
    df_print: paged
    toc_float: yes
---

```{r}
library(tidyverse)
library(here)
library(janitor)
library(stringr)
library(readxl)
library(psych)
library(assertr)
library(testthat)
```

1 MVP
1.1 Task 1 - Decathlon Data
This data is contained in the .rds file decathlon.rds. You’ll need to use read_rds() from readr to open it.

# Call R file to process the rds file.

```{r}
source(here::here("R_scripts/read_rds_data.R"))
```

```{r}
decathlon_data  
```


# 1.1.2 Analysis questions
  ## 1 Who had the longest long jump seen in the data?
```{r}
decathlon_data %>% 
  filter(long_jump == max(long_jump))
```

  ## 2 What was the average 100m time in each competition?
```{r}
decathlon_data %>% 
  group_by(competition) %>%
   summarise(mean(x100m))
```
  
## 3 Who had the highest total points across both competitions?
```{r}
decathlon_data %>% 
  filter(points== max(points))
```
  ## 4 What was the shot-put scores for the top three competitors in each competition?
```{r}
rbind(decathlon_data %>% 
  filter(competition == "olympicg") %>%
  select(competition,competitor,shot_put) %>%
  group_by(competition, competitor) %>%
  arrange(desc(shot_put)) %>%
  head(3), 
  decathlon_data %>% 
  filter(competition == "decastar") %>%
  select(competition,competitor,shot_put) %>%
  group_by(competition, competitor) %>%
  arrange(desc(shot_put)) %>%
  head(3))



```
  
## 5 What was the average points for competitors who ran the 400m in less than 50 seconds vs. those than ran 400m in more than 50 seconds?

```{r}
rbind(decathlon_data  %>%
    filter(x400m < 50) %>%
    summarise(round(mean(points),2 )) %>%
    distinct() %>%
    paste( " average points where 400m < 50 secs"),
  decathlon_data  %>%
    filter(x400m >= 50) %>%
    summarise( round(mean(points),2)) %>%
    distinct() %>%
    paste( " average points where 400m >= 50 secs")
)

```

# 1.4 Task 4 - Halloween Candy Data
The data is in files boing-boing-candy-2015.xlxs, boing-boing-candy-2016.xlxs and boing-boing-candy-2017.xlxs. Bear in mind that this is trickier compared with tasks 1, 2 & 3.

```{r}

source(here::here("R_scripts/read_in_candy_data.R"))


```


## Output to show valid country data
    2015 was populated using 2016 residence data and looping to populate
    the larger data set.
```{r}
candy_data %>% distinct(country) 
```



# Now the three years of data need to be merged. 

```{r}

source(here::here("R_scripts/drop_cols_and_merge.R"))

```

```{r}
glimpse(candy_data)

```

# 1.4.2 Analysis questions

## 1. What is the total number of candy ratings given across the three years. (number of candy ratings, not number of raters. Don’t count missing values)

```{r}
candy_long <- candy_data  %>%
    pivot_longer(cols=6:80, values_drop_na = TRUE) 

   candy_long %>% summarise(sum(n()))

 
```


## 2. What was the average age of people who are going out trick or treating and the average age of people not going trick or treating?

```{r}


candy_data %>%
  select(are_you_going_actually_going_trick_or_treating_yourself, 
          how_old_are_you) %>%
  drop_na() %>%
  group_by(are_you_going_actually_going_trick_or_treating_yourself) %>%
  summarise(mean = round(mean(how_old_are_you)))

  # as many ages are implausible (0-300) restrict the age to 5-100
candy_data %>%
  select(are_you_going_actually_going_trick_or_treating_yourself, 
          how_old_are_you) %>%
  filter(how_old_are_you >= 5 & how_old_are_you <= 100) %>%
  drop_na() %>%
  group_by(are_you_going_actually_going_trick_or_treating_yourself) %>%
  summarise(mean = round(mean(how_old_are_you)))
```

## 3. For each of joy, despair and meh, which candy bar received the most of these ratings?

```{r}
pivot_candy <- candy_data  %>%
    pivot_longer(cols=6:80,   names_to = "candy_bar_name", 
                              values_to = "customer_satisfaction",
                              values_drop_na = TRUE)

# pivot_candy_group <- pivot_candy %>% 
   #  select(candy_bar_name,   customer_satisfaction)  %>%
  #   group_by( customer_satisfaction) %>%
 #     mutate(candy_bar_num = n()) 
    
 #pivot_candy_group %>%
#    arrange(customer_satisfaction, candy_bar_name, candy_bar_num) %>%
#    top_n(customer_satisfaction, n=1)

pivot_candy %>% 
      group_by(candy_bar_name)  %>%
      filter(customer_satisfaction == "DESPAIR") %>%
      select(candy_bar_name,customer_satisfaction)  %>%
      count() %>%
      arrange(desc(n)) %>%
      head(1)  %>%
      paste(" --- Despair")

pivot_candy %>% 
      group_by(candy_bar_name)  %>%
      filter(customer_satisfaction == "MEH") %>%
      select(candy_bar_name, customer_satisfaction)  %>%
      count() %>%
      arrange(desc(n)) %>%
      head(1) %>%
      paste(" --- Meh")


pivot_candy %>% 
      group_by(candy_bar_name)  %>%
      filter(customer_satisfaction == "JOY") %>%
      select(candy_bar_name, customer_satisfaction)  %>%
      count() %>%
      arrange(desc(n)) %>%
      head(1)%>%
      paste(" --- Joy")
```



## 4 How many people rated Starburst as despair?

```{r}
pivot_candy %>% 
      group_by(candy_bar_name)  %>%
      filter(toupper( candy_bar_name) == "STARBURST" & 
                      customer_satisfaction == "DESPAIR") %>%
      select(candy_bar_name, customer_satisfaction) %>%
      count() 
```

# For the next three questions, count despair as -1, joy as +1 and meh as 0.

## 6 (?) What was the most popular candy bar by this rating system for each gender in the dataset?

```{r}


pivot_candy[pivot_candy == "JOY"] <-     "1"
pivot_candy[pivot_candy == "MEH"] <-     "0"
pivot_candy[pivot_candy == "DESPAIR"] <- "-1"
pivot_candy$customer_satisfaction <- as.numeric(pivot_candy$customer_satisfaction)


# As 'other' and 'I'd ratuher not say' look to be the same then combine 
# NA's are not converted
pivot_candy[pivot_candy == "I'd rather not say"] <- "Other"
```

 As any full sized candy bar may not qualify took it out

```{r}

candy_sum <- pivot_candy %>%
  select(your_gender, candy_bar_name, customer_satisfaction)  %>%
  group_by(your_gender, candy_bar_name) 

candy_sum <- candy_sum %>%
  filter(!is.na(your_gender)) %>%
  filter(!is.na(candy_bar_name)) %>%
  summarise(sum = sum(customer_satisfaction))  %>%
  arrange(desc(sum))

rbind( 
    candy_sum %>%
      filter(your_gender == "Female") %>%
      head(1),
    candy_sum %>%
      filter(your_gender == "Male") %>%
      head(1),
    candy_sum %>%
      filter(your_gender == "Other") %>%
      head(1)
)


```
# 7 What was the most popular candy bar in each year?

```{r}
candy_2015 <- pivot_candy %>%
  select(timestamp,  candy_bar_name, customer_satisfaction)  %>%
  filter(timestamp == "2015")  %>%
  group_by(timestamp,  candy_bar_name) %>%
  summarise(timestamp, candy_bar_name, sum = sum(customer_satisfaction))  %>%
  arrange(desc(sum))  %>%
  head(1)

candy_2016 <- pivot_candy %>%
  select(timestamp,  candy_bar_name, customer_satisfaction)  %>%
  filter(timestamp == "2016")  %>%
  group_by(timestamp,  candy_bar_name) %>%
  summarise(timestamp, candy_bar_name, sum = sum(customer_satisfaction))  %>%
  arrange(desc(sum))  %>%
  head(1)

candy_2017 <- pivot_candy %>%
  select(timestamp,  candy_bar_name, customer_satisfaction)  %>%
  filter(timestamp == "2017")  %>%
  group_by(timestamp,  candy_bar_name) %>%
  summarise(timestamp, candy_bar_name, sum = sum(customer_satisfaction))  %>%
  arrange(desc(sum))  %>%
  head(1)

rbind(candy_2015,candy_2016,candy_2017)

```

# 8. What was the most popular candy bar by this rating for people in US, Canada, UK and all other countries?

```{r}


country_candy <- pivot_candy %>%
        mutate(country =  
          case_when(country  
                      %in% c("usa","canada","united kingdom") ~
                      country, 
                      TRUE ~ "other" )) %>%
        select(country,  
             candy_bar_name, 
             customer_satisfaction)  %>%
        filter(!is.na(country)) %>%
        group_by(country,  candy_bar_name) 

country_candy %>%
  summarise( sum = sum(case_when(customer_satisfaction == "MEH" ~ 0,
                                 customer_satisfaction == "DESPAIR" ~ -1,
                                 customer_satisfaction == "JOY" ~ 1)))  %>%
     top_n(1,sum) %>%  # Want to use slice_max as top_n but won't work 
  arrange(country, desc(sum), .by_group = TRUE)  


```


# 2 Extensions

## The data is available in the file rwa.csv. This dataset comes from https://openpsychometrics.org/_rawdata/. It measures how people score on a measure called Right Wing Authoritarianism, or RWA.

### 2.1.1 Some cleaning hints
You’ll need to calculate people’s overall RWA score. This is found from the mean of questions 3 to 22. Questions 1 and 2 are warm up questions. Note that the following questions are reverse scored: 4, 6, 8, 9, 11, 13, 15, 18, 20, 21.
Read the file rwa_codebook.txt to understand how to clean this data. [Hint: you may want to recode some of the variables to give their values meaning].


# Read in the data
```{r}
source(here::here("R_scripts/read_in_rwa_data.R"))
```

```{r}
glimpse(rwa_data)

rwa_data %>%
  select(starts_with("q" ), rwa_score) %>%
  head(2)
```


#  2.1.2 Analysis questions
## 1. What’s the average RWA score for each gender?
```{r}

rwa_data %>%
  select(gender, rwa_score) %>%
  filter(!gender == 0) %>%
  group_by(gender) %>%
  summarise( mean(rwa_score)) 

```

##  2. What’s the average RWA score for left handed people vs. right handed people.

```{r}
rwa_data %>%
  select(hand, rwa_score) %>%
  filter(!hand == 0) %>%
  group_by(hand) %>%
  summarise( mean(rwa_score)) 
```
## 3. What’s the average family size for each type of childhood?

```{r}

rwa_data %>%
  select(urban, familysize) %>%
  filter(!urban == 0) %>%
  group_by(urban) %>%
  summarise( round(mean(familysize)))
```

## 4  What’s the average time to take the test for each education level?
```{r}
rwa_data %>%
  select(education, testelapse) %>%
  filter(!education == 0) %>%
  group_by(education) %>%
  summarise( round(mean(testelapse)))

```
## 5. Create a plot of results of question 4.

```{r}
data <- rwa_data %>%
  select(education, testelapse) %>%
  filter(!education == 0) %>%
  group_by(education) %>%
  summarise( round(mean(testelapse)))
education <- table(data)
plot(education)
```

## 6. What’s the average RWA score for people aged
Under 18
18 to 25
26 to 40
41 to 60

```{r}

rwa_data %>% 
  select(age, rwa_score) %>%
  mutate(age_cuts = cut(age, c(0,18,25,26,40,41,60))) %>%
  filter(!is.na(age_cuts)) %>%
  group_by(age_cuts) %>%
  summarise(avg_rwa_score =round(mean(rwa_score)))

```

# 2.2 Task 6 - Dog owners survey
The data is available in the file dog_survey.csv It is the results of a survey filled in by dog owners about their dogs.

# Read in the data
```{r}
source(here::here("R_scripts/read_in_dog_survey.R"))

```


```{r}
glimpse(dog_survey)

```

# 2.2.2 Analysis questions

## 1. The client only counts a valid email address as one ending in ‘.com’. How many survey results have a valid email address.
```{r}
dog_survey %>%
 select(email, contains(".com")) %>%
  summarise(sum(n()))
  
```


## 2. What’s the average amount spent on dog food for each dog size.

```{r}
"%ni%" <- Negate("%in%")
dog_sums <- dog_survey %>%
              filter(!is.na(amount_spent_on_dog_food)) %>%
              filter( dog_size != "NA") %>%
              filter(dog_size %ni% c( "NO","N/A")) %>%
              group_by(dog_size) 
dog_sums %>% 
  summarise(mean(amount_spent_on_dog_food))
```

## 3. For owners whose surname starts with a letter in the second half of the alphabet (N onwards) what is the average age of their dog?

```{r}

dog_sums <- dog_survey %>%
  filter(substr(last_name,1,1) >= "N") 

dog_sums %>%
  summarise(mean(dog_age))

```

## 4. The dog_age column is the age in dog years. If the conversion is 1 human year = 6 dog years, then what is the average human age for dogs of each gender?

```{r}
dog_sums <- dog_survey %>%
              filter(!is.na(dog_age)) %>%
              group_by(dog_gender) 

dog_sums %>%
  summarise(round(mean(dog_age/6)))
```

## 5. Create a plot of results of question 4.

```{r}
dog_sums <- dog_survey %>%
              filter(!is.na(dog_age)) %>%
              group_by(dog_gender) 

dog_sums <- dog_sums %>%
  summarise(round(mean(dog_age/6)))
colnames(dog_sums) <- c("gender", "age")

dog_years <- table(dog_sums)


#barplot(dog_years,  ylim=c(0,10), ylab="mean dog human years age",main="Barplot of Dog Gender v average age")

plot(dog_years,  ylim=c(0,10), ylab="mean dog human years age", main="Barplot of Dog Gender v average age")
```
End of PDA
